Questa repository contiene il codice per l\textquotesingle{}host del BMS basato su Arduino 2.\hypertarget{md__r_e_a_d_m_e_autotoc_md1}{}\doxysection{Table of contents}\label{md__r_e_a_d_m_e_autotoc_md1}

\begin{DoxyItemize}
\item Come funziona
\begin{DoxyItemize}
\item Processo
\end{DoxyItemize}
\item Invio e ricezione
\begin{DoxyItemize}
\item Command format
\begin{DoxyItemize}
\item CMD0 CMD1
\item PEC0 PEC1
\item Command code
\end{DoxyItemize}
\end{DoxyItemize}
\item Codice
\begin{DoxyItemize}
\item Configurazione
\item Stato
\item Comandi
\item Timer
\end{DoxyItemize}
\item Sviluppo
\end{DoxyItemize}\hypertarget{md__r_e_a_d_m_e_autotoc_md2}{}\doxysection{Come funziona}\label{md__r_e_a_d_m_e_autotoc_md2}
Il BMS (Battery Managment System) è il software che permette la lettura della temperatura, tensione e altri dati significati dai 16 slave. Ogni slave legge i valori da 18 celle (9 parallelo) per un totale di 288. ~\newline
\hypertarget{md__r_e_a_d_m_e_autotoc_md3}{}\doxysubsection{Processo}\label{md__r_e_a_d_m_e_autotoc_md3}
Il BMS si compone di un Arduino 2 (vedi sezione Sviluppo) che, tramite 4-\/wire SPI, comunica con un modulo \href{https://www.analog.com/media/en/technical-documentation/data-sheets/LTC6820.pdf}{\texttt{ LTC-\/6820}} a cui invia l\textquotesingle{}indirizzo dello slave con cui vuole comunicare e il comando che si desidera eseguire.

Il 6820 in configurazione \char`\"{}multidrop\char`\"{} si connette a tutti gli slave in parallelo comunicando tramite 2-\/wire iso\+SPI con gli \href{https://www.analog.com/media/en/technical-documentation/data-sheets/LTC6811-1-6811-2.pdf}{\texttt{ LTC-\/6811-\/2}} montati su ognuno di questi e, grazie all\textquotesingle{}uso di qualche magia n$\ast$gra, riesce ad individuare e ricevere i dati dallo slave desiderato.

\hypertarget{md__r_e_a_d_m_e_autotoc_md4}{}\doxysection{Invio e ricezione}\label{md__r_e_a_d_m_e_autotoc_md4}
Come detto in precedenza, per ricevere i dati da un determinato slave è necessario inviare al 6820 l\textquotesingle{}indirizzo di questo e il comando da eseguire.\hypertarget{md__r_e_a_d_m_e_autotoc_md5}{}\doxysubsection{Command format}\label{md__r_e_a_d_m_e_autotoc_md5}
Il formato dei comandi da inviare all\textquotesingle{}LTC è il seguente\+:

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{9}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8    }\\\cline{1-9}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ 8    }\\\cline{1-9}
\endhead
\PBS\centering CMD0   &\PBS\centering CMD1   &\PBS\centering PEC0   &\PBS\centering PEC1   &\PBS\centering Data Byte Low$\ast$   &\PBS\centering ...   &\PBS\centering Data Byte High$\ast$   &\PBS\centering PEC0$\ast$   &\PBS\centering PEC1$\ast$   \\\cline{1-9}
\end{longtabu}


La notazione è in big endian ⚠️ ~\newline


Il primo PEC viene calcolato sul comando inviato e il secondo sul payload\hypertarget{md__r_e_a_d_m_e_autotoc_md6}{}\doxysubsubsection{CMD0 CMD1}\label{md__r_e_a_d_m_e_autotoc_md6}
CMD0 e CMD1 sono formattati nel seguente modo\+:

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{10}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ RD/\+WR   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT7   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT6   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT5   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT4   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT3   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT2   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT1   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT0    }\\\cline{1-10}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ RD/\+WR   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT7   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT6   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT5   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT4   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT3   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT2   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT1   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ BIT0    }\\\cline{1-10}
\endhead
\PBS\centering CMD0   &\PBS\centering WR   &\PBS\centering 1   &\PBS\centering a3$\ast$   &\PBS\centering a2$\ast$   &\PBS\centering a1$\ast$   &\PBS\centering a0$\ast$   &\PBS\centering CC\mbox{[}10\mbox{]}   &\PBS\centering CC\mbox{[}9\mbox{]}   &\PBS\centering CC\mbox{[}8\mbox{]}    \\\cline{1-10}
\PBS\centering CMD1   &\PBS\centering WR   &\PBS\centering CC\mbox{[}7\mbox{]}   &\PBS\centering CC\mbox{[}6\mbox{]}   &\PBS\centering CC\mbox{[}5\mbox{]}   &\PBS\centering CC\mbox{[}4\mbox{]}   &\PBS\centering CC\mbox{[}3\mbox{]}   &\PBS\centering CC\mbox{[}2\mbox{]}   &\PBS\centering CC\mbox{[}1\mbox{]}   &\PBS\centering CC\mbox{[}0\mbox{]}   \\\cline{1-10}
\end{longtabu}


Dove ax$\ast$ è l\textquotesingle{}indirizzo in binario dello slave, e CC\mbox{[}x\mbox{]} è il comando.\hypertarget{md__r_e_a_d_m_e_autotoc_md7}{}\doxysubsubsection{PEC0 PEC1}\label{md__r_e_a_d_m_e_autotoc_md7}
Il PEC (Packet Error Code) è un \href{https://it.wikipedia.org/wiki/Cyclic_redundancy_check}{\texttt{ CRC}} di 15 bit. Nel datasheet è presente la funziona già implementata che noi, per non saper nè leggere nè scrivere, copiamo e incolliamo.\hypertarget{md__r_e_a_d_m_e_autotoc_md8}{}\doxysubsubsection{CC}\label{md__r_e_a_d_m_e_autotoc_md8}
La tabella 38 (6811) fornisce tutti i comandi possibile. ~\newline
 LTC6811 è diviso in 4 gruppi di registri\+:

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{4}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Cell1   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Cell2   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Cell3    }\\\cline{1-4}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Cell1   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Cell2   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Cell3    }\\\cline{1-4}
\endhead
\PBS\centering Group A   &\PBS\centering 1   &\PBS\centering 2   &\PBS\centering 3    \\\cline{1-4}
\PBS\centering Group B   &\PBS\centering 4   &\PBS\centering 5   &\PBS\centering 6    \\\cline{1-4}
\PBS\centering Group C   &\PBS\centering 7   &\PBS\centering 8   &\PBS\centering 9    \\\cline{1-4}
\PBS\centering Group D   &\PBS\centering 10   &\PBS\centering 11   &\PBS\centering 12   \\\cline{1-4}
\end{longtabu}


Noi utilizzeremo solo fino al gruppo C.\hypertarget{md__r_e_a_d_m_e_autotoc_md9}{}\doxysection{Codice}\label{md__r_e_a_d_m_e_autotoc_md9}
\hypertarget{md__r_e_a_d_m_e_autotoc_md10}{}\doxysubsection{Configurazione}\label{md__r_e_a_d_m_e_autotoc_md10}
La configurazione viene scritta con il comando {\ttfamily WRCFGA} (write configuration register A) e viene letta con il comando {\ttfamily RDCFGA} (read configuration register A). Vedi tabella 40 (6811). ~\newline
\hypertarget{md__r_e_a_d_m_e_autotoc_md11}{}\doxysubsection{Stato}\label{md__r_e_a_d_m_e_autotoc_md11}
I registri di stato considerevoli sono\+:


\begin{DoxyItemize}
\item Group A\+:
\begin{DoxyItemize}
\item {\ttfamily SC} (somma voltaggi delle celle), primi 2 byte
\end{DoxyItemize}
\item Group B
\begin{DoxyItemize}
\item {\ttfamily C\mbox{[}N\mbox{]}OV}, flag di overvoltage della cella \mbox{[}N\mbox{]}, i-\/esimo bit dispari
\item {\ttfamily C\mbox{[}N\mbox{]}UV}, flag di undervoltage della cella \mbox{[}N\mbox{]}, i-\/esimo bit pari
\end{DoxyItemize}
\end{DoxyItemize}

La notazione è in big endian ⚠️\hypertarget{md__r_e_a_d_m_e_autotoc_md12}{}\doxysubsection{Comandi}\label{md__r_e_a_d_m_e_autotoc_md12}
{\ttfamily ADCVSC} legge le tensioni dagli ADC salvandole nei {\itshape \mbox{\hyperlink{struct_cell}{Cell}} Voltage Register Group n}, inoltre salva la tensione totale nei primi 2 byte del {\itshape Status register Group A}. ~\newline


{\ttfamily RDCV\mbox{[}N\mbox{]}} invia la richiesta di trasmissione del contenuto dei registri del gruppo \mbox{[}N\mbox{]}. ~\newline


{\ttfamily RDSTATA} invia la richiesta di trasmissione del contenuto dei registri di status del gruppo A. ~\newline


{\ttfamily ADAX} salva il valore dei GPIO (temperature) nei registri {\itshape Auxiliary Register Group A} (GPIO 1-\/3) e {\itshape B} (GPIO 4, 5)\hypertarget{md__r_e_a_d_m_e_autotoc_md13}{}\doxysubsection{Timer}\label{md__r_e_a_d_m_e_autotoc_md13}


Quando watchdog timer va in timout (2 secondi di inattività)\+: ~\newline



\begin{DoxyItemize}
\item Discharge timer non impostato\+: la scheda va in sleep
\item Discharge timer impostato\+:
\begin{DoxyItemize}
\item non scaduto\+: la scheda va in extended balancing e scarica le celle secondo i PWM impostati
\item scaduto\+: la scheda va in sleep
\end{DoxyItemize}
\end{DoxyItemize}

Quando la scheda va in sleep la configurazione {\ttfamily CFGA} viene resettato e va re-\/inizializzato al prossimo comando.\hypertarget{md__r_e_a_d_m_e_autotoc_md14}{}\doxysection{Sviluppo}\label{md__r_e_a_d_m_e_autotoc_md14}

\begin{DoxyItemize}
\item \mbox{[} \mbox{]} La soluzione finale sarà sostituire l\textquotesingle{}Arduino 2 con l\textquotesingle{}Aurix. 
\end{DoxyItemize}